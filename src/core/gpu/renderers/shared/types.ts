/**
 * Shared types for GPU renderers
 * Used by Object, Terrain, and Water renderers for consistent IBL and shadow support
 */

import { mat4, vec3 } from 'gl-matrix';

/**
 * IBL (Image-Based Lighting) resources for environment lighting
 * Generated by DynamicSkyIBL and consumed by all renderers
 */
export interface IBLResources {
  /** Pre-convolved diffuse irradiance cubemap */
  diffuseCubemap: GPUTextureView;
  /** Pre-filtered specular environment cubemap (with mip levels for roughness) */
  specularCubemap: GPUTextureView;
  /** BRDF integration LUT (split-sum approximation) */
  brdfLut: GPUTextureView;
  /** Optional cubemap sampler (uses default if not provided) */
  cubemapSampler?: GPUSampler;
  /** Optional BRDF LUT sampler (uses default if not provided) */
  lutSampler?: GPUSampler;
}

/**
 * Shadow map resources for shadow receiving
 */
export interface ShadowResources {
  /** Depth texture view from shadow pass */
  shadowMapView: GPUTextureView;
  /** Light-space transformation matrix */
  lightSpaceMatrix: mat4 | Float32Array;
  /** Shadow bias to prevent acne */
  bias?: number;
  /** Enable soft shadow PCF filtering */
  softShadows?: boolean;
  /** Shadow fade distance (for distance-based fade out) */
  fadeDistance?: number;
}

/**
 * Combined environment parameters for rendering
 * Passed to renderers each frame
 */
export interface EnvironmentParams {
  /** IBL resources (null = use placeholder, ambient-only lighting) */
  ibl: IBLResources | null;
  /** Shadow resources (null = no shadows) */
  shadow: ShadowResources | null;
  /** Global ambient intensity (fallback when IBL not available) */
  ambientIntensity?: number;
}

/**
 * Common render parameters shared across renderers
 */
export interface CommonRenderParams {
  /** Combined view-projection matrix */
  viewProjectionMatrix: mat4 | Float32Array;
  /** Camera world position */
  cameraPosition: vec3 | [number, number, number];
  /** Primary light direction (normalized) */
  lightDirection?: vec3 | [number, number, number];
  /** Primary light color (HDR, can be > 1.0) */
  lightColor?: [number, number, number];
  /** Light-space matrix for shadow mapping */
  lightSpaceMatrix?: mat4 | Float32Array;
  /** Enable shadow receiving */
  shadowEnabled?: boolean;
  /** Shadow bias */
  shadowBias?: number;
  /** Current time in seconds (for animations) */
  time?: number;
}

/**
 * Bind group slot assignments (standardized across renderers)
 * 
 * Group 0: Per-frame global uniforms (camera, light, time)
 * Group 1: Per-material or per-renderer uniforms (material properties)
 * Group 2: Textures (PBR textures, heightmaps, etc.)
 * Group 3: Environment (shadow + IBL) - SHARED LAYOUT
 */
export const BIND_GROUP_SLOTS = {
  GLOBAL: 0,
  MATERIAL: 1,
  TEXTURES: 2,
  ENVIRONMENT: 3,
} as const;

/**
 * Environment bind group layout (Group 3)
 * Shared across Object, Terrain, and Water renderers
 * 
 * Binding 0: Shadow depth texture (single map, non-CSM)
 * Binding 1: Shadow comparison sampler
 * Binding 2: IBL diffuse cubemap
 * Binding 3: IBL specular cubemap
 * Binding 4: BRDF LUT texture
 * Binding 5: IBL cubemap sampler
 * Binding 6: IBL LUT sampler
 * Binding 7: CSM shadow map array (4 cascades)
 * Binding 8: CSM uniforms buffer (matrices + splits + config)
 */
export const ENVIRONMENT_BINDINGS = {
  SHADOW_MAP: 0,
  SHADOW_SAMPLER: 1,
  IBL_DIFFUSE: 2,
  IBL_SPECULAR: 3,
  BRDF_LUT: 4,
  IBL_CUBE_SAMPLER: 5,
  IBL_LUT_SAMPLER: 6,
  CSM_SHADOW_ARRAY: 7,
  CSM_UNIFORMS: 8,
} as const;

/**
 * Bitmask for selecting which environment bindings to include
 * Used by SceneEnvironment.getLayoutForMask() and getBindGroupForMask()
 * to create partial bind groups for renderers that don't need all resources
 */
export const ENV_BINDING_MASK = {
  SHADOW_MAP: 1 << ENVIRONMENT_BINDINGS.SHADOW_MAP,        // 1
  SHADOW_SAMPLER: 1 << ENVIRONMENT_BINDINGS.SHADOW_SAMPLER, // 2
  IBL_DIFFUSE: 1 << ENVIRONMENT_BINDINGS.IBL_DIFFUSE,       // 4
  IBL_SPECULAR: 1 << ENVIRONMENT_BINDINGS.IBL_SPECULAR,     // 8
  BRDF_LUT: 1 << ENVIRONMENT_BINDINGS.BRDF_LUT,             // 16
  IBL_CUBE_SAMPLER: 1 << ENVIRONMENT_BINDINGS.IBL_CUBE_SAMPLER, // 32
  IBL_LUT_SAMPLER: 1 << ENVIRONMENT_BINDINGS.IBL_LUT_SAMPLER,   // 64
  CSM_SHADOW_ARRAY: 1 << ENVIRONMENT_BINDINGS.CSM_SHADOW_ARRAY, // 128
  CSM_UNIFORMS: 1 << ENVIRONMENT_BINDINGS.CSM_UNIFORMS,         // 256
  
  // Common presets
  /** Shadow resources only (shadow map + comparison sampler) */
  SHADOW: (1 << ENVIRONMENT_BINDINGS.SHADOW_MAP) | (1 << ENVIRONMENT_BINDINGS.SHADOW_SAMPLER),
  /** CSM shadow resources (array + uniforms + sampler) */
  CSM_SHADOW: (1 << ENVIRONMENT_BINDINGS.CSM_SHADOW_ARRAY) | (1 << ENVIRONMENT_BINDINGS.CSM_UNIFORMS) | 
              (1 << ENVIRONMENT_BINDINGS.SHADOW_SAMPLER),
  /** Full shadow resources (single + CSM) */
  FULL_SHADOW: (1 << ENVIRONMENT_BINDINGS.SHADOW_MAP) | (1 << ENVIRONMENT_BINDINGS.SHADOW_SAMPLER) |
               (1 << ENVIRONMENT_BINDINGS.CSM_SHADOW_ARRAY) | (1 << ENVIRONMENT_BINDINGS.CSM_UNIFORMS),
  /** Diffuse IBL only (diffuse cubemap + cube sampler) - for terrain */
  DIFFUSE_IBL: (1 << ENVIRONMENT_BINDINGS.IBL_DIFFUSE) | (1 << ENVIRONMENT_BINDINGS.IBL_CUBE_SAMPLER),
  /** Full IBL (diffuse + specular + BRDF LUT + samplers) - for PBR objects */
  FULL_IBL: (1 << ENVIRONMENT_BINDINGS.IBL_DIFFUSE) | (1 << ENVIRONMENT_BINDINGS.IBL_SPECULAR) |
            (1 << ENVIRONMENT_BINDINGS.BRDF_LUT) | (1 << ENVIRONMENT_BINDINGS.IBL_CUBE_SAMPLER) |
            (1 << ENVIRONMENT_BINDINGS.IBL_LUT_SAMPLER),
  /** All legacy resources - default for most renderers (without CSM) */
  ALL_LEGACY: 0x7F, // Original 7 bindings
  /** All resources including CSM - for CSM-aware renderers */
  ALL: 0x1FF, // All 9 bindings
} as const;

export type EnvironmentBindingMask = number;
